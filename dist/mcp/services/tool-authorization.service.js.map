{"version":3,"file":"tool-authorization.service.js","sourceRoot":"","sources":["../../../src/mcp/services/tool-authorization.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { McpError, ErrorCode } from '@modelcontextprotocol/sdk/types.js';\nimport { DiscoveredTool } from './mcp-registry.service';\nimport { ToolMetadata, SecurityScheme } from '../decorators/tool.decorator';\nimport { JwtPayload } from '../../authz/services/jwt-token.service';\n\n/**\n * Service responsible for tool-level authorization logic\n */\n@Injectable()\nexport class ToolAuthorizationService {\n  /**\n   * Generate security schemes for a tool based on its metadata and module configuration\n   *\n   * @param tool - The discovered tool\n   * @param moduleHasGuards - Whether the module has guards configured\n   * @returns Array of security schemes for the tool\n   */\n  generateSecuritySchemes(\n    tool: DiscoveredTool<ToolMetadata>,\n    moduleHasGuards: boolean,\n  ): SecurityScheme[] {\n    const metadata = tool.metadata;\n    const schemes: SecurityScheme[] = [];\n\n    // If tool is marked as @PublicTool(), it can be accessed without auth\n    if (metadata.isPublic) {\n      schemes.push({ type: 'noauth' });\n    }\n\n    // If tool has required scopes, add oauth2 scheme with those scopes\n    if (metadata.requiredScopes && metadata.requiredScopes.length > 0) {\n      schemes.push({ type: 'oauth2', scopes: metadata.requiredScopes });\n    }\n    // Else if module has guards and tool is not public, require oauth2\n    else if (moduleHasGuards && !metadata.isPublic) {\n      schemes.push({ type: 'oauth2' });\n    }\n\n    // If no schemes were added, tool is accessible without authentication\n    if (schemes.length === 0) {\n      schemes.push({ type: 'noauth' });\n    }\n\n    return schemes;\n  }\n\n  /**\n   * Check if a user can access a tool based on security requirements\n   *\n   * @param user - The authenticated user (may be undefined)\n   * @param tool - The discovered tool\n   * @param moduleHasGuards - Whether the module has guards configured\n   * @param allowUnauthenticatedAccess - Whether unauthenticated access is allowed (freemium mode)\n   * @returns true if user can access the tool, false otherwise\n   */\n  canAccessTool(\n    user: JwtPayload | undefined,\n    tool: DiscoveredTool<ToolMetadata>,\n    moduleHasGuards: boolean,\n    allowUnauthenticatedAccess: boolean = false,\n  ): boolean {\n    const metadata = tool.metadata;\n\n    // If tool is public, always allow access\n    if (metadata.isPublic) {\n      return true;\n    }\n\n    // If tool has specific scope/role requirements, user MUST be authenticated\n    const hasSpecificRequirements =\n      (metadata.requiredScopes && metadata.requiredScopes.length > 0) ||\n      (metadata.requiredRoles && metadata.requiredRoles.length > 0);\n\n    if (hasSpecificRequirements && !user) {\n      return false;\n    }\n\n    // If tool has specific scopes, validate them\n    if (metadata.requiredScopes && metadata.requiredScopes.length > 0) {\n      if (!this.hasRequiredScopes(user, metadata.requiredScopes)) {\n        return false;\n      }\n    }\n\n    // If tool has specific roles, validate them\n    if (metadata.requiredRoles && metadata.requiredRoles.length > 0) {\n      if (!this.hasRequiredRoles(user, metadata.requiredRoles)) {\n        return false;\n      }\n    }\n\n    // At this point:\n    // - Tool is not public\n    // - Tool has no specific scope/role requirements (or they passed)\n    //\n    // Decision logic based on allowUnauthenticatedAccess:\n    //\n    // allowUnauthenticatedAccess = false (default, standard auth mode):\n    // - Guards are expected to fully authorize requests (via JWT, API keys, etc)\n    // - If guard let request through AND there's no user object:\n    //   * Guard used non-JWT auth mechanism (API key, IP whitelist, etc)\n    //   * Trust the guard's decision to authorize\n    // - If no guards configured, allow access (no auth required)\n    //\n    // allowUnauthenticatedAccess = true (freemium mode):\n    // - Guards may let unauthenticated requests through for per-tool auth\n    // - Only @PublicTool or tools with specific scopes/roles accessible\n    // - Tools without decorators require authentication (user must be present)\n    //\n    if (allowUnauthenticatedAccess && moduleHasGuards && !user) {\n      // Freemium mode: unauthenticated access only for @PublicTool or specific scopes\n      // This tool has no decorators, so it requires authentication\n      return false;\n    }\n\n    // Standard mode: If we're here, either:\n    // - No guards (open access)\n    // - Guards authorized it (trust guard decision, even without user object)\n    // - User is present and passed all checks\n    return true;\n  }\n\n  /**\n   * Validate that a user can access a tool, throwing an error if not authorized\n   *\n   * @param user - The authenticated user (may be undefined)\n   * @param tool - The discovered tool\n   * @param moduleHasGuards - Whether the module has guards configured\n   * @param allowUnauthenticatedAccess - Whether unauthenticated access is allowed (freemium mode)\n   * @throws McpError if user is not authorized to access the tool\n   */\n  validateToolAccess(\n    user: JwtPayload | undefined,\n    tool: DiscoveredTool<ToolMetadata>,\n    moduleHasGuards: boolean,\n    allowUnauthenticatedAccess: boolean = false,\n  ): void {\n    const metadata = tool.metadata;\n    const toolName = metadata.name;\n\n    // If tool is public, allow access\n    if (metadata.isPublic) {\n      return;\n    }\n\n    // Check if tool has specific scope/role requirements\n    const hasSpecificRequirements =\n      (metadata.requiredScopes && metadata.requiredScopes.length > 0) ||\n      (metadata.requiredRoles && metadata.requiredRoles.length > 0);\n\n    if (hasSpecificRequirements && !user) {\n      throw new McpError(\n        ErrorCode.InvalidRequest,\n        `Tool '${toolName}' requires authentication`,\n      );\n    }\n\n    // Validate scopes if required\n    if (metadata.requiredScopes && metadata.requiredScopes.length > 0) {\n      if (!this.hasRequiredScopes(user, metadata.requiredScopes)) {\n        throw new McpError(\n          ErrorCode.InvalidRequest,\n          `Tool '${toolName}' requires scopes: ${metadata.requiredScopes.join(', ')}`,\n        );\n      }\n    }\n\n    // Validate roles if required\n    if (metadata.requiredRoles && metadata.requiredRoles.length > 0) {\n      if (!this.hasRequiredRoles(user, metadata.requiredRoles)) {\n        throw new McpError(\n          ErrorCode.InvalidRequest,\n          `Tool '${toolName}' requires roles: ${metadata.requiredRoles.join(', ')}`,\n        );\n      }\n    }\n\n    // At this point:\n    // - Tool is not public\n    // - Tool has no specific scope/role requirements (or they passed)\n    //\n    // Decision logic based on allowUnauthenticatedAccess:\n    //\n    // allowUnauthenticatedAccess = false (default, standard auth mode):\n    // - Guards are expected to fully authorize requests (via JWT, API keys, etc)\n    // - If guard let request through AND there's no user object:\n    //   * Guard used non-JWT auth mechanism (API key, IP whitelist, etc)\n    //   * Trust the guard's decision to authorize\n    // - If no guards configured, allow access (no auth required)\n    //\n    // allowUnauthenticatedAccess = true (freemium mode):\n    // - Guards may let unauthenticated requests through for per-tool auth\n    // - Only @PublicTool or tools with specific scopes/roles accessible\n    // - Tools without decorators require authentication (user must be present)\n    //\n    if (allowUnauthenticatedAccess && moduleHasGuards && !user) {\n      // Freemium mode: unauthenticated access only for @PublicTool or specific scopes\n      // This tool has no decorators, so it requires authentication\n      throw new McpError(\n        ErrorCode.InvalidRequest,\n        `Tool '${toolName}' requires authentication`,\n      );\n    }\n\n    // Standard mode: If we're here, either:\n    // - No guards (open access)\n    // - Guards authorized it (trust guard decision, even without user object)\n    // - User is present and passed all checks\n  }\n\n  /**\n   * Check if user has all required scopes\n   *\n   * @param user - The authenticated user (may be undefined)\n   * @param requiredScopes - Array of required scope strings\n   * @returns true if user has all required scopes\n   */\n  private hasRequiredScopes(\n    user: JwtPayload | undefined,\n    requiredScopes: string[],\n  ): boolean {\n    if (!user) {\n      return false;\n    }\n\n    // Get user scopes - could be in 'scope' (space-delimited string) or 'scopes' (array)\n    let userScopes: string[] = [];\n\n    if (user.scope) {\n      // OAuth 2.0 standard: space-delimited string\n      userScopes = user.scope.split(' ').filter((s) => s.length > 0);\n    } else if ((user as any).scopes && Array.isArray((user as any).scopes)) {\n      // Alternative: array of scopes\n      userScopes = (user as any).scopes;\n    }\n\n    // Check if user has ALL required scopes\n    return requiredScopes.every((required) => userScopes.includes(required));\n  }\n\n  /**\n   * Check if user has all required roles\n   *\n   * @param user - The authenticated user (may be undefined)\n   * @param requiredRoles - Array of required role strings\n   * @returns true if user has all required roles\n   */\n  private hasRequiredRoles(\n    user: JwtPayload | undefined,\n    requiredRoles: string[],\n  ): boolean {\n    if (!user) {\n      return false;\n    }\n\n    // Get user roles from user data\n    let userRoles: string[] = [];\n\n    if ((user as any).roles && Array.isArray((user as any).roles)) {\n      userRoles = (user as any).roles;\n    } else if (\n      user.user_data &&\n      user.user_data.roles &&\n      Array.isArray(user.user_data.roles)\n    ) {\n      userRoles = user.user_data.roles;\n    }\n\n    // Check if user has ALL required roles\n    return requiredRoles.every((required) => userRoles.includes(required));\n  }\n}\n"]}